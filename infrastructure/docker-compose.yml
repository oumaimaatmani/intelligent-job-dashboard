# Production-grade Docker Compose for Intelligent Job Dashboard
# Focus: Reliability, Security, Observability, Resource Management

services:
  postgres:
    image: postgres:15
    container_name: ijob-postgres
    restart: unless-stopped
    shm_size: 256mb
    environment:
      POSTGRES_USER: jobadmin
      POSTGRES_PASSWORD: jobsecure123
      POSTGRES_DB: intelligent_jobs_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U jobadmin -d intelligent_jobs_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 45s
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  redis:
    image: redis:7
    container_name: ijob-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1.5G
        reservations:
          cpus: "0.25"
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  airflow:
    build:
      context: ./airflow
      dockerfile: Dockerfile
    container_name: ijob-airflow
    restart: unless-stopped
    environment:
      # Core Configuration
      AIRFLOW_HOME: /opt/airflow
      AIRFLOW__CORE__DAGS_FOLDER: /opt/airflow/dags
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql://jobadmin:jobsecure123@postgres:5432/intelligent_jobs_db
      # Security
      AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "false"
      AIRFLOW__CORE__FERNET_KEY: 7M6RVVTa_jzZYj6cEp9rjYF_T-DhV-gJ1n4k8p_lR5U=
      # Performance
      PYTHONPATH: /opt/airflow:/opt/airflow/src
    ports:
      - "8080:8080"
    volumes:
      - ./airflow/entrypoint.sh:/opt/airflow/entrypoint.sh
      - ./airflow/dags:/opt/airflow/dags
      - ../src:/opt/airflow/src
      - ../data:/data
      - airflow_logs:/opt/airflow/logs
    depends_on:
      postgres:
        condition: service_healthy
    entrypoint: ["/bin/bash", "/opt/airflow/entrypoint.sh"]
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  airflow_logs:
    driver: local
